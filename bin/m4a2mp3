#!/bin/bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

MUSIC_PATH="$DIR/../src/public/music"
BITRATE="128"
RESET=false

while [ $# -gt 0 ] ; do
  key="$1"
  case $key in
    -m|--music-path)
      MUSIC_PATH="$2"
      shift
    ;;
    -b|--bitrate)
      BITRATE="$2"
      shift
    ;;
    --reset)
      RESET=true
    ;;
    *)
    ;;
  esac
  shift
done

main() {
  if [ "$RESET" = true ] ; then
    rm "$MUSIC_PATH"/*.mp3
  fi

  for f in "$MUSIC_PATH"/*.m4a ; do
    ffmpeg -i "$f" -vn -map_metadata -1 -acodec libmp3lame -ab "${BITRATE}k" "$MUSIC_PATH/$(basename "$f" .m4a).mp3"
  done

  exit 0
}

main "$@"
